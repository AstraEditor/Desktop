name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

jobs:

# ==========================================
# 统一构建阶段 (webpack:prod)
# ==========================================
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - name: Install dependencies
        run: |
          rm -f package-lock.json
          npm install --loglevel=info

      - name: Fetch
        run: npm run fetch

      - name: Compile
        run: npm run webpack:prod

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            dist-astra-extensions/
            dist-extensions/
            dist-library-files/
            dist-renderer-webpack/

# ==========================================
# Linux 多格式打包
# ==========================================
  package-linux:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        format: [debian, tarball, appimage, pacman, rpm]
        arch: [x64, armv7l, arm64]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y strip-nondeterminism fakeroot ruby ruby-dev rubygems libarchive-tools rpm

      - name: Install fpm
        run: sudo gem install --no-document fpm

      - name: Install dependencies (skip postinstall)
        run: |
          rm -f package-lock.json
          npm install --ignore-scripts

      - name: Package
        run: |
          node release-automation/build.mjs \
            --${{ matrix.format }} \
            --${{ matrix.arch }} \
            --production

      - uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.format }}-${{ matrix.arch }}
          path: dist/*

# ==========================================
# Flatpak (独立构建)
# ==========================================
  package-flatpak:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
    steps:
    - uses: actions/checkout@v4

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 24

    - name: Install Flatpak & Runtime
      run: |
        sudo apt-get update
        sudo apt-get install -y flatpak flatpak-builder
        flatpak --user remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
        flatpak --user install -y --noninteractive flathub org.freedesktop.Platform//23.08
        flatpak --user install -y --noninteractive flathub org.freedesktop.Sdk//23.08
  
    - name: Install dependencies
      run: npm ci

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: linux-build
        path: dist-linux

    - name: Build Linux app
      run: npm run build:linux

    - name: Prepare Flatpak sources
      run: |
        mkdir -p dist-linux
        cp dist-linux/linux-unpacked/astraeditor-desktop dist-linux/

    - name: Build Flatpak
      run: |
        flatpak-builder build-dir flatpak/org.astraeditor.AstraEditor.yml --force-clean
        flatpak build-bundle build-dir AstraEditor.flatpak org.astraeditor.AstraEditor
        mkdir -p dist
        mv AstraEditor.flatpak dist/

    - uses: actions/upload-artifact@v4
      with:
        name: linux-flatpak-x64
        path: dist/*.flatpak
# ==========================================
# Snap
# ==========================================
  package-snap:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Install snapcraft
        run: |
          sudo apt-get update
          sudo apt-get install -y snapd
          sudo snap install snapcraft --classic

      - uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Install dependencies
        run: |
          rm -f package-lock.json
          npm install --ignore-scripts

      - name: Package
        run: |
          node release-automation/build.mjs --snap --x64 --production

      - uses: actions/upload-artifact@v4
        with:
          name: linux-snap-x64
          path: dist/*.snap

# ==========================================
# Mac
# ==========================================
  package-mac:
    needs: build
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - args: '--mac --universal'
            name: modern
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Install dependencies
        run: |
          rm -f package-lock.json
          npm install --ignore-scripts

      - name: Package
        run: |
          node release-automation/build.mjs \
            ${{ matrix.args }} \
            --production

      - uses: actions/upload-artifact@v4
        with:
          name: mac-${{ matrix.name }}
          path: dist/*.dmg

# ==========================================
# Windows
# ==========================================
  package-windows:
    needs: build
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - args: '--windows --x64'
            name: nsis-x64
    steps:
      - uses: actions/checkout@v4
        with:
          path: repo

      - uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: repo/

      - uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Install dependencies
        working-directory: repo
        run: |
          Remove-Item package-lock.json -Force -ErrorAction SilentlyContinue
          npm install --ignore-scripts

      - name: Package
        working-directory: repo
        run: |
          node release-automation/build.mjs \
            ${{ matrix.args }} \
            --production

      - uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.name }}
          path: repo/dist/*.exe

# ==========================================
# 发布到 GitHub Releases
# ==========================================
  publish:
    needs:
      - package-linux
      - package-flatpak
      - package-snap
      - package-mac
      - package-windows
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: '*'
          path: dist
          merge-multiple: true

      - name: List artifacts
        run: ls -lh dist/

      - name: Upload to GitHub Releases
        run: |
          node scripts/upload-to-github-releases.mjs \
            "${{ github.repository_owner }}" \
            "${{ github.event.repository.name }}" \
            "dist/*"
        env:
          GH_TOKEN: "${{ github.token }}"